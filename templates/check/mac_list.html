{% extends 'check/device_info.html' %}

{% block title %}
{{ dev.name }}
{% endblock %}

{% block content %}
<style>
.custom-popover {
    max-width: 100%;
    font-size: 16px;
    font-family: monospace;
}
</style>


    <h2 style="text-align: center">{{ dev.name }} ({{ dev.ip }})</h2>

    <div class="container text-center alert">
        <div class="row row-cols-auto">

            {# Включить/выключить #}
            <div class="col">
                {% if perms >= 2 %}
                    <div class="btn-group-vertical" role="group">
                      <button type="button" class="btn btn-outline-success" style="height: 19px; font-size: 10px; padding-top: 2px;"
                             onclick="reload_port('{{ port }}', '{{ desc }}', 'up')"
                             data-bs-toggle="tooltip" data-bs-placement="left"
                             data-bs-title="Включить порт">
                          ▲
                      </button>

                      <button type="button" class="btn btn-outline-danger" style="height: 19px; font-size: 10px; padding-top: 2px;"
                             onclick="reload_port('{{ port }}', '{{ desc }}', 'down')"
                             data-bs-toggle="tooltip" data-bs-placement="left"
                             data-bs-title="Выключить порт">
                          ▼
                      </button>
                    </div>
                {% endif %}

                {# Перезагрузить #}
                {% if perms >= 1 %}
                    {% csrf_token %}
                    <button type="button" class="btn btn-outline-warning" style="cursor: pointer"
                         onclick="reload_port('{{ port }}', '{{ desc }}', 'reload')"
                         data-bs-toggle="tooltip" data-bs-placement="top"
                         data-bs-title="Перезагрузить порт">
                        Reload
                    </button>
                {% endif %}
            </div>

            {# Имя порта #}
            <div class="col">
                <span class="btn btn-light position-relative">
                    {{ port }}

                    {# Тип порта медь/оптика #}
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                              id="port-type"
                        >{{ port_type | lower }}
                        </span>
                </span>
            </div>

            {# Конфигурация порта #}
            <div class="col" id="port-config">

            </div>

        </div>
    </div>

    <h3 class="alert alert-primary">{{ desc }}</h3>

    <hr>

    {# Информация о интерфейсе #}
    <div class="container" id="port-info">{{ port_info | safe }}</div>

    <hr>

{#    Обновлять MAC автоматически   #}
    <div class="form-check form-switch" style="margin-bottom: 30px">
      <input class="form-check-input" type="checkbox" role="switch" id="auto-update-macs">
      <label class="form-check-label" for="auto-update-macs">Обновлять MAC автоматически</label>
    </div>


{# Таблица МАКОВ #}
    <div id="macs-table">
        <div class="d-flex align-items-center">
          <strong>Загрузка...</strong><span class=""> Некоторое оборудование может грузиться около 30 секунд</span>
          <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
        </div>
    </div>

{% csrf_token %}

{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
<script>
var popoverTriggerList
var popoverList

const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

{% if perms > 0 or request.user.is_superuser %}
    function reload_port(port, desc, status) {
        if (confirm('Слыш!\nУверен(а), что хочешь ' + status + ' порт:\n"' + desc + '"?')) {
            let data = {
                    port: port,
                    device: "{{ dev.name }}",
                    desc: desc,
                    status: status,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]')[0].value
                }
            $.ajax( {
                url: "{% url 'port_reload' %}",
                type: 'POST',
                data: data,
                success: function( data ) {
                    $('#toast_message').html(data.message)
                    $('#toast_color').attr('fill', data.color)
                    $('#toast_title').html(data.status)
                    $('.toast').toast('show')
                }
            } );
        }
    }
{% endif %}


function get_macs() {

    if ( document.getElementById('auto-update-macs').checked ) {

        {# Если нажато автообновление, то отправляем результаты #}

        let data = {
            port: "{{ port }}",
            device: "{{ dev.name }}",
            desc: "{{ desc }}",
            ajax: 'mac',
            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]')[0].value
        }
        console.log(data)

        $.ajax({
            url: "{% url 'get_mac' %}",
            type: 'GET',
            data: data,
            success: function( data ) {
                console.log(data)
                $('#macs-table').html(data.macs)
            }
        });
    }

    timer()
}

{# Повторный сбор маков через 10 секунд #}
    let t
    function timer() {
        t = setTimeout(get_macs, 10000);
    }
    timer();

function start() {
    let data = {
        port: "{{ port }}",
        device: "{{ dev.name }}",
        desc: "{{ desc }}",
        ajax: 'all',
        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]')[0].value
    }
    console.log(data)

    $.ajax({
        url: "{% url 'get_mac' %}",
        type: 'GET',
        data: data,
        success: function( data ) {
            console.log(data)

            var re = new RegExp('\n', 'g');

            if (data.port_config) {
                $('#port-config').html(
                `<button id="port-config" style="margin-left: 30px" type="button" class="btn btn-outline-primary"
                    data-bs-toggle="popover" data-bs-placement="bottom"
                    data-bs-custom-class="custom-popover"
                    data-bs-title="Текущая"
                    data-bs-content="`+data.port_config.replace(re, '<br>')+`"
                >Конфигурация порта</button>`)
            }


            $('#port-info').html(data.port_info)
            $('#macs-table').html(data.macs)


            if (data.port_type === 'SFP') {
                $('#port-type').css({"backgroundColor":"#3e6cff"}).html('sfp')
            }
            if (data.port_type === 'COPPER') {
                $('#port-type').css({"backgroundColor":"#b87333"}).html('copper')
            }

            window.popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            window.popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                        return new bootstrap.Popover(popoverTriggerEl,{html: true})
                    });

        }
    });
}
start()

</script>
{% endblock %}