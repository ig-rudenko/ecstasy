{% extends 'check/base.html' %}
{% load static %}

{% block title %}
{{ dev.name }}
{% endblock %}


{% block toast %}
<div aria-live="polite" aria-atomic="true" class="sticky-top">
  <div class="toast-container position-absolute top-0 end-0 p-3">

    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <svg class="bd-placeholder-img rounded me-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg"
             aria-hidden="true" preserveAspectRatio="xMidYMid slice" focusable="false">
            <rect id="toast_color"  width="100%" height="100%" fill="#007aff"></rect>
        </svg>
        <strong id="toast_title" class="me-auto">INFO</strong>
        <small id="toast_extra" class="text-muted">только что</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Закрыть"></button>
      </div>
      <div id="toast_message" class="toast-body">
        Сообщение
      </div>
    </div>

  </div>
</div>
{% endblock %}


{% block content %}
    <h2 style="margin-bottom: 10px;"><name>{{ dev.name }}</name> ({{ dev.ip }})
        {% if not ping %}
            <span class="badge bg-danger">Оборудование недоступно</span>
        {% endif %}
    </h2>
    <button class="btn btn-info" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasScrolling"
            aria-controls="offcanvasScrolling">Подробная информация</button>

    <a class="btn btn-danger" target="_blank" href="http://10.100.0.50/zabbix/hostinventories.php?hostid={{ zabbix_host_id }}">В Zabbix -></a>

    <a class="btn btn-info" target="_blank" href="{% url 'get_logs' dev.name %}">Логи</a>


{#    Ссылка на карту#}
    {% if dev.zabbix_info.inventory.coordinates %}
        {% with dev.zabbix_info.inventory.coordinates as coord %}
    <div style="margin-top: 20px;">
        <a class="text-decoration-none text-dark" target="_blank" href="https://yandex.ru/maps/959/sevastopol/?mode=search&sll={{ coord.0 }}%2C{{ coord.1 }}&text={{ coord.0 }}%2C{{ coord.1 }}&z=17">
            <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 1a9.002 9.002 0 0 0-6.366 15.362c1.63 1.63 5.466 3.988 5.693 6.465.034.37.303.673.673.673.37
                0 .64-.303.673-.673.227-2.477 4.06-4.831 5.689-6.46A9.002 9.002 0 0 0 12 1z" fill="#F43"></path>
                <path d="M12 13.079a3.079 3.079 0 1 1 0-6.158 3.079 3.079 0 0 1 0 6.158z" fill="#fff"></path>
            </svg>Yandex (Посмотреть на карте)
        </a>
    </div>
        {% endwith %}
    {% endif %}
{#    #}

    <figure class="text-end">
      <blockquote class="blockquote">
        {% if current_status %}
        <p>Интерфейсы были опрошены <time id="time_passed">только что</time></p>
        {% else %}
        <p>Интерфейсы были взяты из предыдущего опроса</p>
        {% endif %}
      </blockquote>


        {% if current_status %}
      <figcaption class="blockquote-footer">
        Для обновления, требуется перезагрузить страницу
      </figcaption>
        {% else %}
      <figcaption class="blockquote-footer">
    <a class="btn" style="background-color: #93c4ff" data-bs-toggle="modal" data-bs-target="#staticBackdrop"
       onclick="window.location.href='{% url 'device_info' dev.name %}?current_status=1'">
        Посмотреть текущее состояние портов</a>
      </figcaption>
        {% endif %}
    </figure>


{% if current_status %}
    {#    Обновлять ИНТЕРФЕЙСЫ автоматически   #}
    <div class="form-check form-switch" style="margin-bottom: 30px">
      <input class="form-check-input" type="checkbox" role="switch" id="auto-update-interfaces" checked>
      <label class="form-check-label" for="auto-update-interfaces">Обновлять автоматически</label>
    </div>
{% endif %}

    {# БУДУЩАЯ ТАБЛИЦА С ИНТЕРФЕЙСАМИ #}
    <div id="interfaces-table">
        <div class="d-flex align-items-center">
          <strong>Загрузка...</strong><span class=""> Некоторое оборудование может грузиться около 30 секунд</span>
          <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
        </div>
    </div>

<!-- Информация с Zabbix -->
<div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasScrollingLabel">Информация с Zabbix</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Закрыть"></button>
  </div>
  <div class="offcanvas-body">
    <div>
        <div class="card card-body">{{ dev.zabbix_info.description }}</div>
        {% for k, v in dev.zabbix_info.inventory.to_dict.items %}
            <p>{{ k }}:</p>
            <ul>{{ v|linebreaks }}</ul>
        {% endfor %}

    </div>
  </div>
</div>

{% csrf_token %}

<button
    type="button"
    class="btn btn-primary btn-floating btn-lg"
    id="btn-back-to-top"
    style="position: fixed;
          bottom: 20px;
          right: 20px;
          display: none;">
<svg id="i-chevron-top" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
    <path d="M30 20 L16 8 2 20" />
</svg>
</button>

{% endblock %}

{% block js %}
<script src="{% static 'js/back_to_top.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous">
</script>

<script>
var last_time = {% now "U" %};  {# Время создания шаблона #}
</script>

{% if perms > 0 or request.user.is_superuser %}
    <script src="{% static 'js/port_control.js' %}"></script>
{% endif %}

{% if current_status %}
    <script src="{% static 'js/timer.js' %}"></script>
    <script src="{% static 'js/get_interfaces_auto.js' %}"></script>
{% else %}
    <script src="{% static 'js/get_interfaces.js' %}"></script>
{% endif %}

{% endblock %}


